<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="https://walker-markdown.oss-cn-shenzhen.aliyuncs.com/uPic/enhanfe.png"
    />
    <link rel="stylesheet" href="/enhanfe/umi.css" />
    <script>
      window.routerBase = "/enhanfe/";
    </script>
    <script>
      //! umi version: 3.5.2
    </script>
    <script>
      !(function () {
        var e = localStorage.getItem("dumi:prefers-color"),
          t = window.matchMedia("(prefers-color-scheme: dark)").matches,
          r = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === r[2] ? (t ? r[1] : r[0]) : r.includes(e) ? e : r[0]
        );
      })();
    </script>
    <title>Babel 浅析</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/advanced/babel" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;https://walker-markdown.oss-cn-shenzhen.aliyuncs.com/uPic/enhanfe.png&#x27;)" href="/enhanfe//">Enhanfe</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span><a href="/enhanfe//basic">💊 基础</a></span><span><a aria-current="page" class="active" href="/enhanfe//advanced">🔥 进阶</a></span><span><a href="/enhanfe//algorithms">🏦 数据结构与算法</a></span><span><a target="_blank" rel="noopener noreferrer" href="https://github.com/HeyiMaster/enhanfe">⭐️  GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></span><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;https://walker-markdown.oss-cn-shenzhen.aliyuncs.com/uPic/enhanfe.png&#x27;)" href="/enhanfe//"></a><h1>Enhanfe</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/enhanfe//basic">💊 基础</a></li><li><a aria-current="page" class="active" href="/enhanfe//advanced">🔥 进阶</a></li><li><a href="/enhanfe//algorithms">🏦 数据结构与算法</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/HeyiMaster/enhanfe">⭐️  GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/enhanfe//advanced/webpack">Tapable 与 Webpack 浅析</a></li><li><a aria-current="page" class="active" href="/enhanfe//advanced/babel">Babel 浅析</a></li><li><a href="/enhanfe//advanced/scaffold">前端项目脚手架开发实践</a></li><li><a href="/enhanfe//advanced/redux">Redux 原理浅析</a></li><li><a href="/enhanfe//advanced/buildownreact">React 原理浅析</a></li><li><a href="/enhanfe//advanced/eventloop">事件系统浅析</a></li><li><a href="/enhanfe//advanced/async">异步处理浅析</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="Babel 简介" data-depth="2"><a href="/enhanfe//advanced/babel#babel-简介"><span>Babel 简介</span></a></li><li title="Babel 工具链" data-depth="2"><a href="/enhanfe//advanced/babel#babel-工具链"><span>Babel 工具链</span></a></li><li title="@babel/parser" data-depth="3"><a href="/enhanfe//advanced/babel#babelparser"><span>@babel/parser</span></a></li><li title="@babel/traverse" data-depth="3"><a href="/enhanfe//advanced/babel#babeltraverse"><span>@babel/traverse</span></a></li><li title="@babel/generator" data-depth="3"><a href="/enhanfe//advanced/babel#babelgenerator"><span>@babel/generator</span></a></li><li title="@babel/types、@babel/template" data-depth="3"><a href="/enhanfe//advanced/babel#babeltypes、babeltemplate"><span>@babel/types、@babel/template</span></a></li><li title="Babel 的启动与配置" data-depth="2"><a href="/enhanfe//advanced/babel#babel-的启动与配置"><span>Babel 的启动与配置</span></a></li><li title="Plugin" data-depth="2"><a href="/enhanfe//advanced/babel#plugin"><span>Plugin</span></a></li><li title="常用 Plugin" data-depth="3"><a href="/enhanfe//advanced/babel#常用-plugin"><span>常用 Plugin</span></a></li><li title="自定义 Babel Plugin" data-depth="3"><a href="/enhanfe//advanced/babel#自定义-babel-plugin"><span>自定义 Babel Plugin</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h2 id="babel-简介"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/babel#babel-简介"><span class="icon icon-link"></span></a>Babel 简介</h2><p>Babel 是 JavaScript 编译器，更确切地说 Babel 是一个工具链，在早期，它主要用于在当前和较旧的浏览器或 js 环境中将 ECMAScript 2015+ 代码转换为 JavaScript 的向后兼容版本。而如今，通过 babel 可以做的事情远不止于此，官方文档给出了 Babel 以下特性：</p><ul><li>转换语法</li><li>目标环境中缺少的 polyfill 功能（通过 <code>@babel/polyfill</code> ）</li><li>源代码转换（codemods）</li></ul><p>除了以上特性，我们还可以借助 Babel 实现自定义编译器，实现更多场景下源代码的转换功能。例如 Taro 1.x 版本，便是使用 Babel 实现基于 Nerv 语法的多端代码转化器，虽然在后来的技术演变中，放弃了这种实现方式，但 Babel 之强大，无可厚非。本文将从 Babel 基础讲起，贯穿 Babel 链路。</p><p>日常中我们使用 Babel 最多的场景大概就是 js 代码转换了，例如 ES6 代码浏览器无法完全支持怎么办？React 应用 JSX 代码如何转换为 js 代码？这两个问题很简单，如果是借助 webpack，我们可以安装 babel-laoder 进行 js 代码处理，最终输出目标代码，不同的是，对于 ES6 代码，我们通常选择 <code>@babel/preset-env</code> 进行支持，而对于 JSX 代码，我们需要选择 <code>@babel/preset-react</code> 包以支持。</p><p><code>@babel/preset-env</code> 可将 ES6 代码转换为兼容代码，简单示例如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// Babel Input: ES2015 arrow function</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> n </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// Babel Output: ES5 equivalent</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> n </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p><code>@babel/preset-react</code> 可将 JSX 代码转换为 js 代码，简单示例如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// Babel Input: JSX</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token operator">&lt;</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token number">123</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// Babel Output: ES5 equivalent</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token maybe-class-name">React</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token string">&#x27;div&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;123&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>由此可见，借助 Babel 可以轻松实现代码转换。</p><h2 id="babel-工具链"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/babel#babel-工具链"><span class="icon icon-link"></span></a>Babel 工具链</h2><p>Babel 转化代码内部实现可概括为：<strong>解析源码生成 AST -&gt; 遍历 AST 调整内容以求得到新的代码输出 -&gt; 生成转换后的代码</strong>。 以上介绍的三步，分别对应了 Babel 提供的三个不同包，分别为：<code>@babel/parser</code>、<code>@babel/traverse</code>、<code>@babel/generator</code> 。这个过程我们用流程图简单描述如下：</p><img src="/enhanfe/static/babel-1.45da5fab.png"/><p>由外而内，我们从 <code>@babel/parser</code> 讲起。</p><h3 id="babelparser"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/babel#babelparser"><span class="icon icon-link"></span></a>@babel/parser</h3><p>介绍这个包之前，我们首先看一行很简单的代码，然后做一个简单分析。如下所示给你一段代码，请你描述这段代码。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">var</span><span class="token plain"> a </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">7</span><span class="token punctuation">;</span></div></pre></div><p>对于 Babel，首先会分析这段代码的一些符号，这段代码中，Babel 这样来描述每个符号：</p><table><thead><tr><th>含义</th><th>符号</th></tr></thead><tbody><tr><td>Keyword</td><td>var</td></tr><tr><td>Identifier</td><td>a</td></tr><tr><td>Punctuator</td><td>=</td></tr><tr><td>Literal</td><td>7</td></tr><tr><td>Punctuator</td><td>;</td></tr></tbody></table><p>首先会针对代码进行词法分析（Lexical Analysis），例如以下例子，词法分析不通过：</p><p><strong>词法分析（Lexical Analysis）</strong></p><p>未结尾的注释</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">/* var a = 7;</span></div></pre></div><p>非法字符</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">var</span><span class="token plain"> a </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">7</span><span class="token plain">°</span><span class="token punctuation">;</span></div></pre></div><p>不正确的二进制数</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">var</span><span class="token plain"> a </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain">b20</span><span class="token punctuation">;</span></div></pre></div><p><strong>语法分析（Syntax Analysis）</strong></p><p>语法分析即是将词法分析所得内容整合到抽象语法树（AST）中。</p><blockquote><p>AST，全称 abstract syntax tree，使用对象描述语法结构。</p></blockquote><p>通过词法分析，我们得到了代码中基本元素，进而需要进行语法分析，串词成句，对于上面所讲到的 <code>var a = 7;</code> 这段代码，进行语法分析后构建抽象语法树，结果如图：</p><img src="/enhanfe/static/babel-2.4d8d3ced.png"/><p><strong>语义分析（Semantic Analysis）</strong></p><p>经过词法、语法分析后，代码还需结合上下文进行语义分析，例如在作用域中使用了某个不曾声明的变量，在作用域中重复声明某个变量等问题。示例代码如下：</p><p>重复声明</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">let</span><span class="token plain"> num </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> num </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation">;</span></div></pre></div><p>使用不在该作用域中的变量</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> str </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;hello&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">str</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>到这里，Babel Parser 已基本完成代码的解析工作，并输出初始代码 AST。进而，我们需要使用 @babel/traverse，遍历代码以生成目标代码。</p><p>以上介绍了 parser 内部流程，我们用一下示例一窥其用法：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;@babel/parser&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">parse</span><span class="token punctuation">(</span><span class="token string">&#x27;code&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// parse in strict mode and allow module declarations</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  sourceType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;module&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  plugins</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// enable jsx and flow syntax</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token string">&#x27;jsx&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token string">&#x27;flow&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><h3 id="babeltraverse"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/babel#babeltraverse"><span class="icon icon-link"></span></a>@babel/traverse</h3><p>看到遍历，我们很容易联想到数组的遍历，而在 AST 中，我们使用的算法是图遍历，更准确的说是 <strong>深度优先搜索</strong>。</p><p><strong>声明遍历（Declarative traversal）</strong>拿到 parser 转化得到的 AST 后，通过遍历以对不同声明进行操作，示例如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token plain">ast</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">CallExpression</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;Call&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p><strong>动态抽象语法树（Dynamic Abstract Syntax Tree）</strong>抽象语法树可能会在遍历过程中，动态调整部分结构，如下例所示：</p><p>遍历到 1 + fn(3) 时，使用 [6, fn] 替换该表达式，CallExpression 替换为 ArrayExpression<img src="/enhanfe/static/babel-3.50335e40.png"/>遍历完后，返回<img src="/enhanfe/static/babel-4.b415f93d.png"/></p><p><strong>作用域分析（Scope analysis）</strong></p><p>以上过程完成了 Babel 抽象语法树遍历过程，并根据实际需求，将初始代码 AST 在遍历过程转换成了目标代码 AST ，接下来需要将目标代码 AST 输出为目标代码。</p><p>以上介绍了 traverse 内部流程，我们用一下示例一窥其用法：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword module">import</span><span class="token plain"> </span><span class="token imports operator">*</span><span class="token imports"> </span><span class="token imports keyword module">as</span><span class="token imports"> parser</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;@babel/parser&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">import</span><span class="token plain"> </span><span class="token imports">traverse</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;@babel/traverse&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> code </span><span class="token operator">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">function square(n) {</span></div><div class="token-line"><span class="token template-string string">  return n * n;</span></div><div class="token-line"><span class="token template-string string">}</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> ast </span><span class="token operator">=</span><span class="token plain"> parser</span><span class="token punctuation">.</span><span class="token method function property-access">parse</span><span class="token punctuation">(</span><span class="token plain">code</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token plain">ast</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">path</span><span class="token punctuation">.</span><span class="token method function property-access">isIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;n&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      path</span><span class="token punctuation">.</span><span class="token property-access">node</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;x&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><h3 id="babelgenerator"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/babel#babelgenerator"><span class="icon icon-link"></span></a>@babel/generator</h3><p>将 AST 转化生成为目标代码，如下例所示：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword module">import</span><span class="token plain"> </span><span class="token imports punctuation">{</span><span class="token imports"> parse </span><span class="token imports punctuation">}</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;@babel/parser&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">import</span><span class="token plain"> </span><span class="token imports">generate</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;@babel/generator&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> a </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;var a = 1;&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> b </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;var b = 2;&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> astA </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token plain">a</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> sourceFilename</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;a.js&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> astB </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token plain">b</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> sourceFilename</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;b.js&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> ast </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;Program&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  body</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">concat</span><span class="token punctuation">(</span><span class="token plain">astA</span><span class="token punctuation">.</span><span class="token property-access">program</span><span class="token punctuation">.</span><span class="token property-access">body</span><span class="token punctuation">,</span><span class="token plain"> astB</span><span class="token punctuation">.</span><span class="token property-access">program</span><span class="token punctuation">.</span><span class="token property-access">body</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> code</span><span class="token punctuation">,</span><span class="token plain"> map </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  ast</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"> sourceMaps</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token string">&#x27;a.js&#x27;</span><span class="token operator">:</span><span class="token plain"> a</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token string">&#x27;b.js&#x27;</span><span class="token operator">:</span><span class="token plain"> b</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><h3 id="babeltypes、babeltemplate"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/babel#babeltypes、babeltemplate"><span class="icon icon-link"></span></a>@babel/types、@babel/template</h3><p><strong>@babel/types</strong></p><p>使用 <code>@babel/types</code> 包可以很轻松进行语法树中节点的类型判断等操作，例如，我们可以用以下方式判断一个节点是表达式：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">t</span><span class="token punctuation">.</span><span class="token method function property-access">isExpression</span><span class="token punctuation">(</span><span class="token plain">node</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>或者可以使用以下方式判断，某个节点是否为 test 为名的标识符。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">t</span><span class="token punctuation">.</span><span class="token method function property-access">isIdentifier</span><span class="token punctuation">(</span><span class="token plain">node</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;test&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>与此同时，使用 <code>@babel/types</code> 可以很轻松构建一个表达式，例如期望将 varId 节点的值增加 2。可以这样使用：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">t</span><span class="token punctuation">.</span><span class="token method function property-access">assignmentExpression</span><span class="token punctuation">(</span><span class="token string">&#x27;+=&#x27;</span><span class="token punctuation">,</span><span class="token plain"> varId</span><span class="token punctuation">,</span><span class="token plain"> t</span><span class="token punctuation">.</span><span class="token method function property-access">numericLiteral</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>转换后，得到如下 AST：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;AssignmentExpression&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  operator</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;+=&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  right</span><span class="token operator">:</span><span class="token plain"> varId</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  left</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;NumericLiteral&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    value</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>接下来，我们看看更为复杂的 AST 构建，需求为：给定一个描述数组的节点 varId，构建语法树使得该数组每个元素增加 2，且最后仅返回值大于 10 的元素。代码示例如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">t</span><span class="token punctuation">.</span><span class="token method function property-access">assignmentExpression</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token string">&#x27;=&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  varId</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  t</span><span class="token punctuation">.</span><span class="token method function property-access">callExpression</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    t</span><span class="token punctuation">.</span><span class="token method function property-access">memberExpression</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      t</span><span class="token punctuation">.</span><span class="token method function property-access">callExpression</span><span class="token punctuation">(</span><span class="token plain">t</span><span class="token punctuation">.</span><span class="token method function property-access">memberExpression</span><span class="token punctuation">(</span><span class="token plain">varId</span><span class="token punctuation">,</span><span class="token plain"> t</span><span class="token punctuation">.</span><span class="token method function property-access">identifier</span><span class="token punctuation">(</span><span class="token string">&#x27;map&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        t</span><span class="token punctuation">.</span><span class="token method function property-access">arrowFunctionExpression</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">[</span><span class="token plain">t</span><span class="token punctuation">.</span><span class="token method function property-access">identifier</span><span class="token punctuation">(</span><span class="token string">&#x27;e&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          t</span><span class="token punctuation">.</span><span class="token method function property-access">binaryExpression</span><span class="token punctuation">(</span><span class="token string">&#x27;+&#x27;</span><span class="token punctuation">,</span><span class="token plain"> t</span><span class="token punctuation">.</span><span class="token method function property-access">identifier</span><span class="token punctuation">(</span><span class="token string">&#x27;e&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> t</span><span class="token punctuation">.</span><span class="token method function property-access">numericLiteral</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      t</span><span class="token punctuation">.</span><span class="token method function property-access">identifier</span><span class="token punctuation">(</span><span class="token string">&#x27;filter&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      t</span><span class="token punctuation">.</span><span class="token method function property-access">arrowFunctionExpression</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">[</span><span class="token plain">t</span><span class="token punctuation">.</span><span class="token method function property-access">identifier</span><span class="token punctuation">(</span><span class="token string">&#x27;e&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        t</span><span class="token punctuation">.</span><span class="token method function property-access">binaryExpression</span><span class="token punctuation">(</span><span class="token string">&#x27;&gt;&#x27;</span><span class="token punctuation">,</span><span class="token plain"> t</span><span class="token punctuation">.</span><span class="token method function property-access">identifier</span><span class="token punctuation">(</span><span class="token string">&#x27;e&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> t</span><span class="token punctuation">.</span><span class="token method function property-access">numericLiteral</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>以上代码着实令人头秃，很多时候，我们期望在可读性高、代码维护成本低的前提下，书写可靠代码，以上示例我们可以通过另外一种方式实现，那就是模板定义。</p><p><strong>@babel/template</strong></p><p>还是以上例为例，我们使用模板方式构建 AST 就非常方便了，代码示例如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword module">import</span><span class="token plain"> </span><span class="token imports">template</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;@babel/template&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">template</span><span class="token punctuation">.</span><span class="token property-access">expression</span><span class="token punctuation">.</span><span class="token property-access">ast</span><span class="token template-string template-punctuation string">`</span><span class="token template-string string"></span></div><div class="token-line"><span class="token template-string string">  </span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">varId</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string"> = </span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">varId</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string"></span></div><div class="token-line"><span class="token template-string string">              .map(e =&gt; e + 2)</span></div><div class="token-line"><span class="token template-string string">              .filter(e =&gt; e &gt; 10)</span></div><div class="token-line"><span class="token template-string string"></span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">;</span></div></pre></div><h2 id="babel-的启动与配置"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/babel#babel-的启动与配置"><span class="icon icon-link"></span></a>Babel 的启动与配置</h2><p>我们最常见 Babel 的使用方式便是在 webpack 工具中，使用 babel-loader 进行 js 资源处理，Babel 的配置可以定义在 package.json 或者 项目下的 .babelrc 中。除了 babel-loader，还可以通过以下方式使用 Babel：</p><ul><li>@babel/cli</li><li>@babel/register</li><li>babelify</li><li>parcel</li><li>babel-loader</li></ul><p>关于 Babel 的配置，我们可以定义在一下文件中：</p><ul><li>babel.config.js</li><li>.babelrc</li><li>package.json</li><li>运行时指定</li></ul><h2 id="plugin"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/babel#plugin"><span class="icon icon-link"></span></a>Plugin</h2><h3 id="常用-plugin"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/babel#常用-plugin"><span class="icon icon-link"></span></a>常用 Plugin</h3><p>Babel 给我们提供了很多实用插件，如下表：</p><table><thead><tr><th>类别</th><th>插件</th></tr></thead><tbody><tr><td>features</td><td>@babel/plugin-transform-classes</td></tr><tr><td>proposals</td><td>@babel/plugin-proposal-optional-chaining</td></tr><tr><td>extensions</td><td>@babel/plugin-transform-typescript<br/>@babel/plugin-transform-react-jsx</td></tr><tr><td>optimization</td><td>@babel/plugin-transform-runtime</td></tr></tbody></table><p>当然，Babel 插件远不止于此，如果你想了解更多 Babel 插件，可自行搜索。</p><h3 id="自定义-babel-plugin"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/babel#自定义-babel-plugin"><span class="icon icon-link"></span></a>自定义 Babel Plugin</h3><p>自定义 Babel plugin 前，我们首先需要明确一下几个观点：</p><ul><li>Babel 插件是一个函数，函数返回一个对象，该对象中的不同属性与方法定义了 plugin 的功能</li><li>插件必须有一个响当当的名字</li><li>定义 Babel 遍历器</li><li>修改 Babel 配置</li><li>继承其他 plugin</li></ul><p>熟悉这几点以后，我们用一个最简单的示例，演示定义一个 Babel Plugin 所需要的最基本元素，示例如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">EnhanfePlugin</span><span class="token punctuation">(</span><span class="token parameter">babel</span><span class="token parameter punctuation">,</span><span class="token parameter"> options</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;enhanfe-plugin&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    visitor</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function maybe-class-name">CallExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">/*...*/</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">manipulateOptions</span><span class="token punctuation">(</span><span class="token parameter">babelOptions</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">/*...*/</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    inherits</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;another-plugin&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>掌握了开发一个 Plugin 最基本的构成后，我们通过一个示例学习 Babel Plugin 的封装。需求如下：手写转换插件，支持对象可选链取值，代码如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">person</span><span class="token operator">?.</span><span class="token plain">name</span><span class="token punctuation">;</span></div></pre></div><p>根据以上 Plugin 定义模板，我们分块编写逻辑，代码与各部分说明如下代码片段所示：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">EnhanfePlugin</span><span class="token punctuation">(</span><span class="token parameter">babel</span><span class="token parameter punctuation">,</span><span class="token parameter"> options</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> types</span><span class="token operator">:</span><span class="token plain"> t</span><span class="token punctuation">,</span><span class="token plain"> template </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> babel</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;enhanfe-plugin&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">manipulateOptions</span><span class="token punctuation">(</span><span class="token parameter">opts</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      opts</span><span class="token punctuation">.</span><span class="token property-access">parserOpts</span><span class="token punctuation">.</span><span class="token property-access">plugin</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token string">&#x27;optionalChanning&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    visitor</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function maybe-class-name">OptionalMemeberExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> object</span><span class="token punctuation">,</span><span class="token plain"> property </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> path</span><span class="token punctuation">.</span><span class="token property-access">node</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 重新构建表达式</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> memberExpr </span><span class="token operator">=</span><span class="token plain"> t</span><span class="token punctuation">.</span><span class="token method function property-access">memberExpression</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          object</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          property</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          path</span><span class="token punctuation">.</span><span class="token property-access">node</span><span class="token punctuation">.</span><span class="token property-access">computed</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 需要处理 undefined 以防止 undefined 作为变量名被赋值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 通过 path 获取到当前作用域，并构建一个 undefined 节点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> relUndefined </span><span class="token operator">=</span><span class="token plain"> path</span><span class="token punctuation">.</span><span class="token property-access">scope</span><span class="token punctuation">.</span><span class="token method function property-access">buildUndefinedNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">        path</span><span class="token punctuation">.</span><span class="token method function property-access">replaceWith</span><span class="token punctuation">(</span><span class="token plain">template</span><span class="token punctuation">.</span><span class="token property-access">expression</span><span class="token punctuation">.</span><span class="token property-access">ast</span><span class="token template-string template-punctuation string">`</span><span class="token template-string string"></span></div><div class="token-line"><span class="token template-string string">          </span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">object</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string"> == null ? </span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">relUndefined</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string"> : </span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">memberExpr</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string"></span></div><div class="token-line"><span class="token template-string string">        </span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><p>以上插件定义对于给定的测试用例，已经可以满足了，但是如果改变可选链长度或者调用形式，以上 Plugin 将无法使用，比如以下场景的取值：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">bags</span><span class="token operator">?.</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">person</span><span class="token operator">?.</span><span class="token plain">children</span><span class="token operator">?.</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">?.</span><span class="token plain">name</span><span class="token punctuation">;</span></div></pre></div><p>为了支持以上用例，我们需要编写更复杂逻辑处理，覆盖尽可能多的测试用例。示例代码如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">EnhanfePlugin</span><span class="token punctuation">(</span><span class="token parameter">babel</span><span class="token parameter punctuation">,</span><span class="token parameter"> options</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> types</span><span class="token operator">:</span><span class="token plain"> t</span><span class="token punctuation">,</span><span class="token plain"> template </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> babel</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;enhanfe-plugin&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">manipulateOptions</span><span class="token punctuation">(</span><span class="token parameter">opts</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      opts</span><span class="token punctuation">.</span><span class="token property-access">parserOpts</span><span class="token punctuation">.</span><span class="token property-access">plugin</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token string">&#x27;optionalChanning&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    visitor</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function maybe-class-name">OptionalMemeberExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 暂存</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> originalPath </span><span class="token operator">=</span><span class="token plain"> path</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> temp </span><span class="token operator">=</span><span class="token plain"> path</span><span class="token punctuation">.</span><span class="token property-access">scope</span><span class="token punctuation">.</span><span class="token method function property-access">generateUidIdentifier</span><span class="token punctuation">(</span><span class="token string">&#x27;obj&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        path</span><span class="token punctuation">.</span><span class="token property-access">scope</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> id</span><span class="token operator">:</span><span class="token plain"> temp </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 如果当前节点存在可选链表示</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">path</span><span class="token punctuation">.</span><span class="token property-access">node</span><span class="token punctuation">.</span><span class="token property-access">optional</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          path </span><span class="token operator">=</span><span class="token plain"> path</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">&#x27;object&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">let</span><span class="token plain"> memberExpr </span><span class="token operator">=</span><span class="token plain"> temp</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword control-flow">do</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          memberExpr </span><span class="token operator">=</span><span class="token plain"> t</span><span class="token punctuation">.</span><span class="token method function property-access">memberExpression</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            memberExpr</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            path</span><span class="token punctuation">.</span><span class="token property-access">node</span><span class="token punctuation">.</span><span class="token property-access">property</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            path</span><span class="token punctuation">.</span><span class="token property-access">node</span><span class="token punctuation">.</span><span class="token property-access">computed</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">          </span><span class="token comment">// 遍历完成，跳出循环</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">path </span><span class="token operator">===</span><span class="token plain"> originalPath</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword control-flow">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          path </span><span class="token operator">=</span><span class="token plain"> path</span><span class="token punctuation">.</span><span class="token property-access">parentPath</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 需要处理 undefined 以防止 undefined 作为变量名被赋值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 通过 path 获取到当前作用域，并构建一个 undefined 节点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> relUndefined </span><span class="token operator">=</span><span class="token plain"> path</span><span class="token punctuation">.</span><span class="token property-access">scope</span><span class="token punctuation">.</span><span class="token method function property-access">buildUndefinedNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">        path</span><span class="token punctuation">.</span><span class="token method function property-access">replaceWith</span><span class="token punctuation">(</span><span class="token plain">template</span><span class="token punctuation">.</span><span class="token property-access">expression</span><span class="token punctuation">.</span><span class="token property-access">ast</span><span class="token template-string template-punctuation string">`</span><span class="token template-string string"></span></div><div class="token-line"><span class="token template-string string">          </span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">object</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string"> == null ? </span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">relUndefined</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string"> : </span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">memberExpr</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string"></span></div><div class="token-line"><span class="token template-string string">        </span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><p>从上例中，我们可以看出 path 遍历是自底向上的，这也说明了对象链式调用的向前推断这一特性。通过以上开发的简单 Babel 插件，Babel 便能支持可选链这一语法，这时你只需要在使用 Babel 的地方引入该插件即可，以 webpack 中 babel-loader 为例，配置 Babel 插件方式如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// .babelrc</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token string">&quot;plugins&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token string">&quot;myPlugin&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token string">&quot;babel-plugin-myPlugin&quot;</span><span class="token plain"> </span><span class="token comment">// equivalent</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>Babel 能做的事情还有很多，我们只需要通过定义 Plugin、Preset 即可借助 Babel 完成代码转换、语法兼容、拓展语言特性等功能。如果你意犹未尽，可以查看 Taro 1.x 源码，核心实现逻辑便是借助 Babel 以完成多端应用编译。</p><p>最后，感谢 Nicolò 大佬分享，文中图片与部分观点借鉴自这位前辈。</p></div><div class="__dumi-default-layout-footer-meta"><span data-updated-text="最后更新时间：">7/3/2021 05:06:26</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/enhanfe/umi.js"></script>
  </body>
</html>
