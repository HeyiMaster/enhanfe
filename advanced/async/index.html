<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="https://walker-markdown.oss-cn-shenzhen.aliyuncs.com/uPic/enhanfe.png"
    />
    <link rel="stylesheet" href="/enhanfe/umi.css" />
    <script>
      window.routerBase = "/enhanfe/";
    </script>
    <script>
      //! umi version: 3.5.2
    </script>
    <script>
      !(function () {
        var e = localStorage.getItem("dumi:prefers-color"),
          t = window.matchMedia("(prefers-color-scheme: dark)").matches,
          r = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === r[2] ? (t ? r[1] : r[0]) : r.includes(e) ? e : r[0]
        );
      })();
    </script>
    <title>å¼‚æ­¥å¤„ç†æµ…æ</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/advanced/async" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;https://walker-markdown.oss-cn-shenzhen.aliyuncs.com/uPic/enhanfe.png&#x27;)" href="/enhanfe//">Enhanfe</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span><a href="/enhanfe//basic">ğŸ’Š åŸºç¡€</a></span><span><a aria-current="page" class="active" href="/enhanfe//advanced">ğŸ”¥ è¿›é˜¶</a></span><span><a href="/enhanfe//algorithms">ğŸ¦ æ•°æ®ç»“æ„ä¸ç®—æ³•</a></span><span><a target="_blank" rel="noopener noreferrer" href="https://github.com/HeyiMaster/enhanfe">â­ï¸Â Â GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></span><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;https://walker-markdown.oss-cn-shenzhen.aliyuncs.com/uPic/enhanfe.png&#x27;)" href="/enhanfe//"></a><h1>Enhanfe</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/enhanfe//basic">ğŸ’Š åŸºç¡€</a></li><li><a aria-current="page" class="active" href="/enhanfe//advanced">ğŸ”¥ è¿›é˜¶</a></li><li><a href="/enhanfe//algorithms">ğŸ¦ æ•°æ®ç»“æ„ä¸ç®—æ³•</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/HeyiMaster/enhanfe">â­ï¸Â Â GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/enhanfe//advanced/webpack">Tapable ä¸ Webpack æµ…æ</a></li><li><a href="/enhanfe//advanced/babel">Babel æµ…æ</a></li><li><a href="/enhanfe//advanced/scaffold">å‰ç«¯é¡¹ç›®è„šæ‰‹æ¶å¼€å‘å®è·µ</a></li><li><a href="/enhanfe//advanced/redux">Redux åŸç†æµ…æ</a></li><li><a href="/enhanfe//advanced/buildownreact">React åŸç†æµ…æ</a></li><li><a href="/enhanfe//advanced/eventloop">äº‹ä»¶ç³»ç»Ÿæµ…æ</a></li><li><a aria-current="page" class="active" href="/enhanfe//advanced/async">å¼‚æ­¥å¤„ç†æµ…æ</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="æ¦‚è¿°" data-depth="2"><a href="/enhanfe//advanced/async#æ¦‚è¿°"><span>æ¦‚è¿°</span></a></li><li title="è§‚å¯Ÿè€…æ¨¡å¼" data-depth="2"><a href="/enhanfe//advanced/async#è§‚å¯Ÿè€…æ¨¡å¼"><span>è§‚å¯Ÿè€…æ¨¡å¼</span></a></li><li title="åŸºç¡€ç‰ˆ Promise å®ç°" data-depth="2"><a href="/enhanfe//advanced/async#åŸºç¡€ç‰ˆ-promise-å®ç°"><span>åŸºç¡€ç‰ˆ Promise å®ç°</span></a></li><li title="Promise A+ è§„èŒƒ" data-depth="2"><a href="/enhanfe//advanced/async#promise-a-è§„èŒƒ"><span>Promise A+ è§„èŒƒ</span></a></li><li title="è¯‘æ–‡æœ¯è¯­" data-depth="3"><a href="/enhanfe//advanced/async#è¯‘æ–‡æœ¯è¯­"><span>è¯‘æ–‡æœ¯è¯­</span></a></li><li title="æœ¯è¯­" data-depth="3"><a href="/enhanfe//advanced/async#æœ¯è¯­"><span>æœ¯è¯­</span></a></li><li title="è¦æ±‚" data-depth="3"><a href="/enhanfe//advanced/async#è¦æ±‚"><span>è¦æ±‚</span></a></li><li title="å¢åŠ  Promise çŠ¶æ€" data-depth="2"><a href="/enhanfe//advanced/async#å¢åŠ -promise-çŠ¶æ€"><span>å¢åŠ  Promise çŠ¶æ€</span></a></li><li title="æ”¯æŒé“¾å¼è°ƒç”¨" data-depth="2"><a href="/enhanfe//advanced/async#æ”¯æŒé“¾å¼è°ƒç”¨"><span>æ”¯æŒé“¾å¼è°ƒç”¨</span></a></li><li title="å€¼è¿‡æ»¤ä¸çŠ¶æ€å˜æ›´" data-depth="2"><a href="/enhanfe//advanced/async#å€¼è¿‡æ»¤ä¸çŠ¶æ€å˜æ›´"><span>å€¼è¿‡æ»¤ä¸çŠ¶æ€å˜æ›´</span></a></li><li title="åŒæ­¥ä»»åŠ¡å¤„ç†" data-depth="2"><a href="/enhanfe//advanced/async#åŒæ­¥ä»»åŠ¡å¤„ç†"><span>åŒæ­¥ä»»åŠ¡å¤„ç†</span></a></li><li title="å…¶ä»–æ–¹æ³•å®ç°" data-depth="2"><a href="/enhanfe//advanced/async#å…¶ä»–æ–¹æ³•å®ç°"><span>å…¶ä»–æ–¹æ³•å®ç°</span></a></li><li title="catch" data-depth="3"><a href="/enhanfe//advanced/async#catch"><span>catch</span></a></li><li title="finally" data-depth="3"><a href="/enhanfe//advanced/async#finally"><span>finally</span></a></li><li title="resolve" data-depth="3"><a href="/enhanfe//advanced/async#resolve"><span>resolve</span></a></li><li title="reject" data-depth="3"><a href="/enhanfe//advanced/async#reject"><span>reject</span></a></li><li title="all" data-depth="3"><a href="/enhanfe//advanced/async#all"><span>all</span></a></li><li title="race" data-depth="3"><a href="/enhanfe//advanced/async#race"><span>race</span></a></li><li title="å®Œæ•´ä»£ç " data-depth="2"><a href="/enhanfe//advanced/async#å®Œæ•´ä»£ç "><span>å®Œæ•´ä»£ç </span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h2 id="æ¦‚è¿°"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/async#æ¦‚è¿°"><span class="icon icon-link"></span></a>æ¦‚è¿°</h2><p>å¼‚æ­¥å¤„ç†åœ¨ç¨‹åºå¼€å‘ä¸–ç•Œé‡Œå¾ˆå¸¸è§ï¼Œå¼‚æ­¥å¯ä»¥ç®€å•æè¿°ä¸ºï¼šç°åœ¨å‘èµ·çš„è¯·æ±‚éœ€è¦åœ¨æœªæ¥æŸä¸ªæ—¶é—´ç‚¹å¾—åˆ°ç­”å¤ã€‚åœ¨æ—©æœŸçš„å‰ç«¯å¼€å‘ä¸–ç•Œé‡Œï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ä»£ç ä¸­å……æ–¥ç€å›è°ƒå‡½æ•°ç‰‡æ®µï¼Œè¯·æ±‚å“åº”å¤„ç†ã€å®šæ—¶å™¨ç­‰æ“ä½œéƒ½éœ€å€ŸåŠ©å›è°ƒå‡½æ•°æ¥å®Œæˆå¼‚æ­¥æ“ä½œã€‚</p><p>å‡å¦‚æˆ‘ä»¬å¸Œæœ›æŸä¸ªå‡½æ•°å…·æœ‰ç­‰å¾…çš„æ•ˆæœï¼Œåœ¨ç­‰å¾…å®Œåï¼Œæ‰“å°ä¼ å…¥çš„å‚æ•°ã€‚ä»£ç ç‰‡æ®µç¤ºä¾‹å¦‚ä¸‹ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token parameter punctuation">,</span><span class="token parameter"> time</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">&#x27;Yeah&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> time</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">message</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>é€šå¸¸åœ¨ä¸€ç§’åä¼šæ‰“å°å‡º â€œYeahâ€ã€‚ä»æœ¬ä¾‹æ¥çœ‹ï¼Œå›è°ƒå‡½æ•°èƒ½å¤Ÿå¾ˆå¥½è§£å†³å¼‚æ­¥å¤„ç†é—®é¢˜ï¼Œä½†åœ¨æœ‰äº›æ—¶å€™ï¼Œå›è°ƒå‡½æ•°ä¼šä½¿å¾—ä»£ç å¯è¯»æ€§æ€¥å‰§é™ä½ï¼Œæ¯”å¦‚ä»¥ä¸‹ä»£ç ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token function">f1</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> t1 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;f1&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">t1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">f2</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> t2 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string">`</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">t1</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">,f2</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">t2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">f3</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> t3 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string">`</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">t2</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">,f3</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">f3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>å¦‚æ­¤åµŒå¥—ï¼Œä»£ç å¯è¯»æ€§ä¼šæ€¥å‰§é™ä½ï¼Œæ­£å¦‚æœ¯è¯­ï¼šå›è°ƒåœ°ç‹±ã€‚</p><p>æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜å—ï¼Ÿæœ‰ï¼Œé‚£å°±æ˜¯ Promiseã€‚æˆ‘ä»¬ä½¿ç”¨ Promise æ”¹å†™ä¸Šé¢çš„ä»£ç ï¼Œå°±åƒè¿™æ ·ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> t1 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;f1&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">t1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> t1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token parameter">t1</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> t2 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string">`</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">t1</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">,f2</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">t2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> t2</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token parameter">t2</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">f3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> t3 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string">`</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">t2</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">,f3</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">f3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> t3</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>è¿™æ ·æˆ‘ä»¬å°±å°†ä¸€å±‚ä¸€å±‚åµŒå¥—è°ƒç”¨çš„å½¢å¼æ”¹å†™æˆäº†å¹³çº§è°ƒç”¨ï¼Œæé«˜äº†ä»£ç å¯è¯»æ€§ã€‚Promise æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿæˆ‘ä»¬è¦ä»ä¸€ç§è®¾è®¡æ¨¡å¼è¯´èµ·ã€‚</p><h2 id="è§‚å¯Ÿè€…æ¨¡å¼"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/async#è§‚å¯Ÿè€…æ¨¡å¼"><span class="icon icon-link"></span></a>è§‚å¯Ÿè€…æ¨¡å¼</h2><blockquote><p>é˜…è¯»å‰å¯å…ˆå›é¡¾ä¸€ä¸‹è§‚å¯Ÿè€…æ¨¡å¼ä¸å‘å¸ƒ-è®¢é˜…æ¨¡å¼çš„åŒºåˆ«</p></blockquote><p>è§‚å¯Ÿè€…æ¨¡å¼å³æ˜¯å…ˆæ”¶é›†æ‰€æœ‰ä¾èµ–ï¼Œå¾…åˆ°éœ€è¦æ‰§è¡Œæ—¶ï¼Œä»ä¾èµ–ä¸­å–å‡ºå‡½æ•°å¹¶ä¾æ¬¡æ‰§è¡Œã€‚è¿™ç§æ€è·¯åœ¨äº‹ä»¶å¤„ç†ä¸­å¾—åˆ°å……åˆ†è¿ç”¨ï¼Œé’ˆå¯¹æŸä¸ª DOM å…ƒç´ ï¼Œç»‘å®šäº‹ä»¶çš„è¿‡ç¨‹ç›¸å½“äºå£°æ˜ä¾èµ–ï¼Œå¾…åˆ°äº‹ä»¶è§¦å‘æ—¶ï¼Œåˆ™å°†è¿™äº›ä¾èµ–å–å‡ºä¾æ¬¡æ‰§è¡Œã€‚</p><h2 id="åŸºç¡€ç‰ˆ-promise-å®ç°"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/async#åŸºç¡€ç‰ˆ-promise-å®ç°"><span class="icon icon-link"></span></a>åŸºç¡€ç‰ˆ Promise å®ç°</h2><p>åœ¨ Promise ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ä»»åŠ¡çš„å¤„ç†å®ŒæˆçŠ¶æ€åˆ†ä¸º resolve å’Œ rejectï¼Œé’ˆå¯¹äºè¿™ä¸¤ç§çŠ¶æ€ï¼Œæˆ‘ä»¬äº‹å…ˆéœ€è¦å°†å„è‡ªä¾èµ–å­˜å‚¨ï¼Œå¾…åˆ°å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œå†å–å‡ºè¿™äº›ä¾èµ–å‡½æ•°ä¾æ¬¡æ‰§è¡Œã€‚æˆ‘ä»¬å…ˆå†™ä¸€éƒ¨åˆ†ç‰‡æ®µï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">type</span><span class="token plain"> </span><span class="token class-name maybe-class-name">FuncType</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token spread operator">...</span><span class="token plain">args</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">export</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">private</span><span class="token plain"> resolves</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token plain">executor</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token function">then</span><span class="token punctuation">(</span><span class="token plain">resolveFunc</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">resolves</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">resolveFunc</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>å¯ä»¥çœ‹åˆ° Promise ä¾èµ–çš„æ”¶é›†æ˜¯åœ¨ then å‡½æ•°ä¸­å®Œæˆï¼Œå½“ Promise ç¤ºä¾‹æ¯è°ƒç”¨ä¸€æ¬¡ thenï¼Œä¾¿å°† then ä¸­ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‡½æ•°æ”¾å…¥ä¾èµ–æ•°ç»„ä¸­ã€‚ä¸è¿‡æˆ‘ä»¬çŸ¥é“ Promise çš„åˆå§‹åŒ–æ˜¯åœ¨å®ä¾‹åŒ–æ—¶å®Œæˆï¼Œå› æ­¤åœ¨æ„é€ å™¨ä¸­éœ€è¦æ‰§è¡Œ Promise å®ä¾‹åŒ–ä¼ å…¥çš„å‡½æ•°ï¼Œä»£ç æ”¹é€ åå¦‚ä¸‹ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">type</span><span class="token plain"> </span><span class="token class-name maybe-class-name">FuncType</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token spread operator">...</span><span class="token plain">args</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">type</span><span class="token plain"> </span><span class="token class-name maybe-class-name">ExecutorFunc</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">resolveFunc</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">,</span><span class="token plain"> rejectFunc</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">export</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">private</span><span class="token plain"> resolves</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token plain">executor</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">ExecutorFunc</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> resolve </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token plain">resolve</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">private</span><span class="token plain"> </span><span class="token function-variable function">resolve</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">resolvedVal</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> resolves </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">resolves</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> cb </span><span class="token operator">=</span><span class="token plain"> resolves</span><span class="token punctuation">.</span><span class="token method function property-access">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">cb</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token plain">resolvedVal</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token function">then</span><span class="token punctuation">(</span><span class="token plain">resolveFunc</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">resolves</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">resolveFunc</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>å®Œæ•´æ‰§è¡Œè¿‡ç¨‹æ˜¯ï¼šå½“æ‰§è¡Œ <code>new HePromise()</code> æ—¶ï¼Œ<code>constructor</code> å‡½æ•°ä¼šæ‰§è¡Œï¼Œä¸è¿‡è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬æš‚æ—¶åªè€ƒè™‘å¼‚æ­¥æ“ä½œï¼Œå¿½ç•¥äº†åŒæ­¥çš„æƒ…å†µã€‚å¼‚æ­¥æƒ…å†µä¸‹ <code>executor</code> å‡½æ•°ä¼šåœ¨æœªæ¥æŸä¸ªæ—¶é—´ç‚¹æ‰§è¡Œï¼Œè€Œä»åˆå§‹åŒ–åˆ°è¿™ä¸ªæ—¶é—´ç‚¹ä¹‹é—´ï¼Œæ­£æ˜¯ <code>then</code> å‡½æ•°æ‰§è¡Œæ”¶é›†ä¾èµ–çš„è¿‡ç¨‹ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘ <code>reject</code> çš„æ“ä½œï¼Œè¿™ä¸ªæ“ä½œä¸ <code>resolve</code> è¡¨å¾ç±»ä¼¼ï¼Œæˆ‘ä»¬ç›´æ¥æ·»åŠ åˆ°ä¸Šé¢ä»£ç ä¸­ï¼Œæ·»åŠ åå®Œæ•´ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">type</span><span class="token plain"> </span><span class="token class-name maybe-class-name">FuncType</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token spread operator">...</span><span class="token plain">args</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">type</span><span class="token plain"> </span><span class="token class-name maybe-class-name">ExecutorFunc</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">resolveFunc</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">,</span><span class="token plain"> rejectFunc</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">export</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">private</span><span class="token plain"> resolves</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">private</span><span class="token plain"> rejects</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token plain">executor</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">ExecutorFunc</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> resolve</span><span class="token punctuation">,</span><span class="token plain"> reject </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token plain">resolve</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">private</span><span class="token plain"> </span><span class="token function-variable function">resolve</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">resolvedVal</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> resolves </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">resolves</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> cb </span><span class="token operator">=</span><span class="token plain"> resolves</span><span class="token punctuation">.</span><span class="token method function property-access">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">cb</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token plain">resolvedVal</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">private</span><span class="token plain"> </span><span class="token function-variable function">reject</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">rejectedVal</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> rejects </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">rejects</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> cb </span><span class="token operator">=</span><span class="token plain"> rejects</span><span class="token punctuation">.</span><span class="token method function property-access">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">cb</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token plain">rejectedVal</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token function">then</span><span class="token punctuation">(</span><span class="token plain">resolveFunc</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">,</span><span class="token plain"> rejectFunc</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">resolves</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">resolveFunc</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">rejectFunc</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">rejects</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">rejectFunc</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç¼–å†™æµ‹è¯•ä»£ç ï¼Œæœ¬é¡¹ç›®ä¸­ä½¿ç”¨ jest è¿›è¡Œæµ‹è¯•ï¼Œæµ‹è¯•ä»£ç ç¼–å†™å¦‚ä¸‹ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#x27;test HePromise&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#x27;basic usage&#x27;</span><span class="token punctuation">,</span><span class="token plain"> done </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> p </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token punctuation">(</span><span class="token plain">resolve </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      p</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">data </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token plain">data</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">done</span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>æ‰§è¡Œæµ‹è¯•ï¼Œæµ‹è¯•é€šè¿‡ï¼Œå®Œæˆ Promise åˆå§‹ç‰ˆæœ¬å°è£…ã€‚æ‰§è¡Œæµç¨‹æ€»ç»“å¦‚ä¸‹ï¼š</p><ul><li>Promise æ„é€ æ–¹æ³•éœ€è¦ä¼ å…¥ä¸€ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªå‡½æ•°å‘½åä¸º <code>executor</code>ï¼›</li><li>åœ¨ <code>executor</code> å†…éƒ¨ï¼Œå°†å„ä»»åŠ¡æ”¾å…¥å®/å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼ˆå®/å¾®ä»»åŠ¡è¯·å‚çœ‹ <a href="/enhanfe//advanced/eventloop">äº‹ä»¶å¾ªç¯</a> ï¼‰ï¼›</li><li>åœ¨ <code>then</code> å’Œ <code>catch</code> ä¸­å¯æ”¶é›†åˆ° <code>resolve</code>ã€<code>reject</code> ä¾èµ–ï¼Œå¹¶å°†è¯¥ä¾èµ–å­˜æ”¾åˆ°å¯¹åº”é˜Ÿåˆ—ä¸­ï¼›</li><li>å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œä»¥åï¼Œè°ƒç”¨ <code>executor</code> ä¸­çš„ <code>resolve</code> æˆ– <code>reject</code>ï¼Œå–å‡ºå¯¹åº”é˜Ÿåˆ—ä¸­çš„ä¾èµ–ä¾æ¬¡æ‰§è¡Œã€‚</li></ul><h2 id="promise-a-è§„èŒƒ"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/async#promise-a-è§„èŒƒ"><span class="icon icon-link"></span></a>Promise A+ è§„èŒƒ</h2><blockquote><p>è‹±æ–‡åŸæ–‡ï¼šPromise/A+</p><p>è½¬è½½è‡ªï¼š<a target="_blank" rel="noopener noreferrer" href="https://www.ituring.com.cn/article/66566">https://www.ituring.com.cn/article/66566<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote><h3 id="è¯‘æ–‡æœ¯è¯­"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/async#è¯‘æ–‡æœ¯è¯­"><span class="icon icon-link"></span></a>è¯‘æ–‡æœ¯è¯­</h3><ul><li>è§£å†³ï¼ˆfulfillï¼‰ï¼šæŒ‡ä¸€ä¸ª promise æˆåŠŸæ—¶è¿›è¡Œçš„ä¸€ç³»åˆ—æ“ä½œï¼Œå¦‚çŠ¶æ€çš„æ”¹å˜ã€å›è°ƒçš„æ‰§è¡Œã€‚è™½ç„¶è§„èŒƒä¸­ç”¨ fulfill æ¥è¡¨ç¤ºè§£å†³ï¼Œä½†åœ¨åä¸–çš„ promise å®ç°å¤šä»¥ resolve æ¥æŒ‡ä»£ä¹‹</li><li>æ‹’ç»ï¼ˆrejectï¼‰ï¼šæŒ‡ä¸€ä¸ª promise å¤±è´¥æ—¶è¿›è¡Œçš„ä¸€ç³»åˆ—æ“ä½œ</li><li>ç»ˆå€¼ï¼ˆeventual valueï¼‰ï¼šæ‰€è°“ç»ˆå€¼ï¼ŒæŒ‡çš„æ˜¯ promise è¢«è§£å†³æ—¶ä¼ é€’ç»™è§£å†³å›è°ƒçš„å€¼ï¼Œç”±äº promise æœ‰ä¸€æ¬¡æ€§çš„ç‰¹å¾ï¼Œå› æ­¤å½“è¿™ä¸ªå€¼è¢«ä¼ é€’æ—¶ï¼Œæ ‡å¿—ç€ promise ç­‰å¾…æ€çš„ç»“æŸï¼Œæ•…ç§°ä¹‹ç»ˆå€¼ï¼Œæœ‰æ—¶ä¹Ÿç›´æ¥ç®€ç§°ä¸ºå€¼ï¼ˆvalueï¼‰</li><li>æ®å› ï¼ˆreasonï¼‰ï¼šä¹Ÿå°±æ˜¯æ‹’ç»åŸå› ï¼ŒæŒ‡åœ¨ promise è¢«æ‹’ç»æ—¶ä¼ é€’ç»™æ‹’ç»å›è°ƒçš„å€¼</li></ul><h3 id="æœ¯è¯­"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/async#æœ¯è¯­"><span class="icon icon-link"></span></a>æœ¯è¯­</h3><ul><li><strong>Promise</strong> promise æ˜¯ä¸€ä¸ªæ‹¥æœ‰ then æ–¹æ³•çš„å¯¹è±¡æˆ–å‡½æ•°ï¼Œå…¶è¡Œä¸ºç¬¦åˆæœ¬è§„èŒƒ</li><li><strong>thenable</strong> æ˜¯ä¸€ä¸ªå®šä¹‰äº† then æ–¹æ³•çš„å¯¹è±¡æˆ–å‡½æ•°ï¼Œæ–‡ä¸­è¯‘ä½œâ€œæ‹¥æœ‰ then æ–¹æ³•â€</li><li><strong>å€¼ï¼ˆvalueï¼‰</strong> æŒ‡ä»»ä½• JavaScript çš„åˆæ³•å€¼ï¼ˆåŒ…æ‹¬ undefined , thenable å’Œ promiseï¼‰</li><li><strong>å¼‚å¸¸ï¼ˆexceptionï¼‰</strong> æ˜¯ä½¿ç”¨ throw è¯­å¥æŠ›å‡ºçš„ä¸€ä¸ªå€¼</li><li><strong>æ®å› ï¼ˆreasonï¼‰</strong> è¡¨ç¤ºä¸€ä¸ª promise çš„æ‹’ç»åŸå› </li></ul><h3 id="è¦æ±‚"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/async#è¦æ±‚"><span class="icon icon-link"></span></a>è¦æ±‚</h3><p><strong>Promise çš„çŠ¶æ€</strong></p><p>ä¸€ä¸ª Promise çš„å½“å‰çŠ¶æ€å¿…é¡»ä¸ºä»¥ä¸‹ä¸‰ç§çŠ¶æ€ä¸­çš„ä¸€ç§ï¼š<strong>ç­‰å¾…æ€ï¼ˆPendingï¼‰</strong>ã€**æ‰§è¡Œæ€ï¼ˆFulfilledï¼‰**å’Œ <strong>æ‹’ç»æ€ï¼ˆRejectedï¼‰</strong>ã€‚</p><ul><li><p><strong>ç­‰å¾…æ€ï¼ˆPendingï¼‰</strong>å¤„äºç­‰å¾…æ€æ—¶ï¼Œpromise éœ€æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p><p>å¯ä»¥è¿ç§»è‡³æ‰§è¡Œæ€æˆ–æ‹’ç»æ€</p></li><li><p><strong>æ‰§è¡Œæ€ï¼ˆFulfilledï¼‰</strong>å¤„äºæ‰§è¡Œæ€æ—¶ï¼Œpromise éœ€æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p><p>ä¸èƒ½è¿ç§»è‡³å…¶ä»–ä»»ä½•çŠ¶æ€</p><p>å¿…é¡»æ‹¥æœ‰ä¸€ä¸ªä¸å¯å˜çš„ç»ˆå€¼</p></li><li><p><strong>æ‹’ç»æ€ï¼ˆRejectedï¼‰</strong>å¤„äºæ‹’ç»æ€æ—¶ï¼Œpromise éœ€æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p><p>ä¸èƒ½è¿ç§»è‡³å…¶ä»–ä»»ä½•çŠ¶æ€</p><p>å¿…é¡»æ‹¥æœ‰ä¸€ä¸ªä¸å¯å˜çš„æ®å› </p><p>è¿™é‡Œçš„ä¸å¯å˜æŒ‡çš„æ˜¯æ’ç­‰ï¼ˆå³å¯ç”¨ === åˆ¤æ–­ç›¸ç­‰ï¼‰ï¼Œè€Œä¸æ˜¯æ„å‘³ç€æ›´æ·±å±‚æ¬¡çš„ä¸å¯å˜ï¼ˆè¯‘è€…æ³¨ï¼šç›–æŒ‡å½“ value æˆ– reason ä¸æ˜¯åŸºæœ¬å€¼æ—¶ï¼Œåªè¦æ±‚å…¶å¼•ç”¨åœ°å€ç›¸ç­‰ï¼Œä½†å±æ€§å€¼å¯è¢«æ›´æ”¹ï¼‰ã€‚</p></li></ul><p><strong>then æ–¹æ³•</strong></p><p>ä¸€ä¸ª promise å¿…é¡»æä¾›ä¸€ä¸ª then æ–¹æ³•ä»¥è®¿é—®å…¶å½“å‰å€¼ã€ç»ˆå€¼å’Œæ®å› ã€‚</p><p>promise çš„ then æ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">promise</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">onFulfilled</span><span class="token punctuation">,</span><span class="token plain"> onRejected</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>å…¶ä¸­ï¼ŒonFulfilled å’Œ onRejected éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚</p><ul><li>å¦‚æœ onFulfilled ä¸æ˜¯å‡½æ•°ï¼Œå…¶å¿…é¡»è¢«å¿½ç•¥</li><li>å¦‚æœ onRejected ä¸æ˜¯å‡½æ•°ï¼Œå…¶å¿…é¡»è¢«å¿½ç•¥</li></ul><p>......</p><h2 id="å¢åŠ -promise-çŠ¶æ€"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/async#å¢åŠ -promise-çŠ¶æ€"><span class="icon icon-link"></span></a>å¢åŠ  Promise çŠ¶æ€</h2><p>æˆ‘ä»¬ä¸º HePromise æ·»åŠ çŠ¶æ€ï¼Œæ ¹æ®è§„èŒƒçº¦å®šï¼Œåœ¨ä»£ç ä¸­æ·»åŠ çŠ¶æ€æšä¸¾å€¼ï¼Œå¦‚ä¸‹ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">enum</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token constant">PENDING</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;pending&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token constant">FULFILLED</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;fulfilled&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token constant">REJECTED</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;rejected&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>åœ¨æ‰§è¡Œ <code>resolve</code> å‰ï¼Œéœ€è¦æ£€æµ‹å½“å‰çŠ¶æ€æ˜¯å¦ä¸º <code>pending</code>ï¼Œå¦‚æœæ˜¯åˆ™å¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™æ— æ³•æ‰§è¡Œ <code>resolve</code>ï¼Œåœ¨æ‰§è¡Œ <code>resolve</code> æ—¶ï¼Œå°†çŠ¶æ€ç½®ä¸º <code>fulfilled</code>ã€‚<code>reject</code> æ–¹æ³•ä¸­åŒç†å…ˆæ£€æµ‹çŠ¶æ€æ˜¯å¦ä¸º <code>pending</code>ï¼Œå¦‚æœæ˜¯åˆ™ç»§ç»­æ‰§è¡Œå¹¶å°†çŠ¶æ€ç½®ä¸º <code>rejected</code>ã€‚</p><p>æ”¹è¿›åï¼Œä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">type</span><span class="token plain"> </span><span class="token class-name maybe-class-name">FuncType</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token spread operator">...</span><span class="token plain">args</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">type</span><span class="token plain"> </span><span class="token class-name maybe-class-name">ExecutorFunc</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">resolveFunc</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">,</span><span class="token plain"> rejectFunc</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">enum</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token constant">PENDING</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;pending&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token constant">FULFILLED</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;fulfilled&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token constant">REJECTED</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;rejected&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">export</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">private</span><span class="token plain"> status </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">private</span><span class="token plain"> resolves</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">private</span><span class="token plain"> rejects</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token plain">executor</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">ExecutorFunc</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> resolve</span><span class="token punctuation">,</span><span class="token plain"> reject </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token plain">resolve</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">private</span><span class="token plain"> </span><span class="token function-variable function">resolve</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">resolvedVal</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> resolves</span><span class="token punctuation">,</span><span class="token plain"> status </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">status </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">resolves</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> cb </span><span class="token operator">=</span><span class="token plain"> resolves</span><span class="token punctuation">.</span><span class="token method function property-access">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">cb</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token plain">resolvedVal</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">private</span><span class="token plain"> </span><span class="token function-variable function">reject</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">rejectedVal</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> rejects</span><span class="token punctuation">,</span><span class="token plain"> status </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">status </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">rejects</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> cb </span><span class="token operator">=</span><span class="token plain"> rejects</span><span class="token punctuation">.</span><span class="token method function property-access">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">cb</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token plain">rejectedVal</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token function">then</span><span class="token punctuation">(</span><span class="token plain">resolveFunc</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">,</span><span class="token plain"> rejectFunc</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">resolves</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">resolveFunc</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">rejectFunc</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">rejects</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">rejectFunc</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h2 id="æ”¯æŒé“¾å¼è°ƒç”¨"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/async#æ”¯æŒé“¾å¼è°ƒç”¨"><span class="icon icon-link"></span></a>æ”¯æŒé“¾å¼è°ƒç”¨</h2><p>æ ¹æ® Promise A+ è§„èŒƒï¼Œæ¯æ¬¡ then è¿”å›çš„å€¼ä¹Ÿéœ€è¦æ»¡è¶³ thenableï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬éœ€è¦å°† resolve è¿”å›å€¼ä½¿ç”¨ promise åŒ…è£¹ï¼Œåœ¨æœ¬ä¾‹ä¸­å°±æ˜¯éœ€è¦å°†è¿”å›å€¼åŒ…è£…ä¸ºæ–°çš„ HePromise å¯¹è±¡ã€‚ å¼€å‘ä¹‹å‰æˆ‘ä»¬ä¸å¦¨å…ˆæ¥çœ‹çœ‹ Promise é“¾å¼è°ƒç”¨çš„ç¤ºä¾‹ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> p </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">p</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token parameter">r1</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">r1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token parameter">r2</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">r2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token parameter">r3</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">r3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>å¯ä»¥å‘ç°ï¼Œæ¯æ¬¡ then å‡½æ•°è°ƒç”¨å®Œï¼Œéƒ½è¿”å›äº†ä¸€ä¸ªæ–°çš„æ•°å­—ï¼Œä»¤äººä¸è§£çš„æ˜¯ï¼Œè¿™ä¸ªæ•°æ®å±…ç„¶ä¹Ÿæ‹¥æœ‰äº† then å‡½æ•°ï¼Œå¯ä»¥ä¾æ¬¡è°ƒç”¨ã€‚è¿™é‡Œéœ€è¦åšçš„å¤„ç†æ—¶ï¼Œéœ€è¦å°†ä¼ å…¥çš„ resolve ä¸ reject å‡½æ•°å°è£…ç„¶åæ”¾å…¥å¾…æ‰§è¡Œé˜Ÿåˆ—ä¸­ã€‚ç®€è¨€ä¹‹ï¼Œå½“è¿”å›å€¼ä¸ºä¸€ä¸ª Promise æ—¶ï¼Œéœ€è¦æ‰§è¡Œ promise.then æ–¹æ³•ï¼Œå¦åˆ™ç›´æ¥æ‰§è¡Œ resolveã€‚æ”¹è¿›åçš„ then æ–¹æ³•å¦‚ä¸‹ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token function">then</span><span class="token punctuation">(</span><span class="token plain">resolveFunc</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">,</span><span class="token plain"> rejectFunc</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">resolve</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">resolvedFn</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">let</span><span class="token plain"> resolvedVal </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">resolveFunc</span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          resolvedVal </span><span class="token keyword">instanceof</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token operator">?</span><span class="token plain"> resolvedVal</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">resolve</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token operator">:</span><span class="token plain"> </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">resolvedVal</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">resolves</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">resolvedFn</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">rejectFunc</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">rejects</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">rejectFunc</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span></div></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œthen æ–¹æ³•è°ƒç”¨æ—¶ï¼Œä¼šè¿”å›æ–°çš„ HePromise å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¸­ä¸»è¦åšäº†è¿™æ ·å‡ ä»¶äº‹æƒ…ï¼š</p><ol><li>åŒ…è£…åˆå§‹ then æ–¹æ³•ä¼ å…¥çš„ resolve å‡½æ•°ï¼›</li><li>å…ˆå°†åˆå§‹ then æ–¹æ³•ä¼ å…¥çš„ resolve å‡½æ•°æ‰§è¡Œï¼Œå¾—åˆ°è¿”å›å€¼ï¼Œå¦‚æœè¿”å›å€¼æ˜¯ä¸€ä¸ªæ–°çš„ HePromise å¯¹è±¡ï¼Œåˆ™éœ€è¦æ‰‹åŠ¨è°ƒç”¨è¯¥å®ä¾‹çš„ then æ–¹æ³•ï¼Œå¦åˆ™ç›´æ¥æ‰§è¡Œ resolve å‡½æ•°ï¼›</li><li>å°†åŒ…è£…è¿‡çš„ resolve å‡½æ•°æ”¾å…¥ resolves é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…æ‰§è¡Œ</li></ol><p>åŒç†å°† reject å¤„ç†è¡¥å…¨ï¼Œæ•´ä½“ä»£ç ç¤ºä¾‹ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token function">then</span><span class="token punctuation">(</span><span class="token plain">resolveFunc</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">,</span><span class="token plain"> rejectFunc</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">resolve</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">resolvedFn</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">const</span><span class="token plain"> resolvedVal </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">resolveFunc</span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          resolvedVal </span><span class="token keyword">instanceof</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token operator">?</span><span class="token plain"> resolvedVal</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">resolve</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token operator">:</span><span class="token plain"> </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">resolvedVal</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">resolves</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">resolvedFn</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">rejectedFn</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">rejectFunc</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">const</span><span class="token plain"> rejectedVal </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">rejectFunc</span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            rejectedVal </span><span class="token keyword">instanceof</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token operator">?</span><span class="token plain"> rejectedVal</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">resolve</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token operator">:</span><span class="token plain"> </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">rejectedVal</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">rejectFunc</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">rejects</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">rejectedFn</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span></div></pre></div><p>å®Œæˆç¼–ç åï¼Œç¼–å†™æµ‹è¯•ä»£ç ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#x27;chain invoke usage&#x27;</span><span class="token punctuation">,</span><span class="token plain"> done </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> p </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token punctuation">(</span><span class="token plain">resolve </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    p</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">data </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token plain">data</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token string">&#x27;hello&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">data </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token plain">data</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token string">&#x27;hello&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token string">&#x27;world&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">data </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token plain">data</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token string">&#x27;world&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">done</span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>æ‰§è¡Œæµ‹è¯•ï¼Œå¯ä»¥çœ‹åˆ°æµ‹è¯•ç”¨ä¾‹é€šè¿‡ã€‚</p><p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ ¹æ® Promise A+ è§„èŒƒï¼Œéœ€è¦å¯¹ then å‚æ•°è¿›è¡Œå¤„ç†ï¼Œå¦‚æœå‚æ•°ä¸æ˜¯å‡½æ•°ï¼Œåˆ™éœ€è¦å¿½ç•¥å¹¶ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">typeof</span><span class="token plain"> resolveFunc </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token string">&#x27;function&#x27;</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function-variable function">resolveFunc</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token parameter">value</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> value</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">typeof</span><span class="token plain"> rejectFunc </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token string">&#x27;function&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token operator">?</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function-variable function">rejectFunc</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token parameter">reason</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">throw</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token plain">reason </span><span class="token keyword">instanceof</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> reason</span><span class="token punctuation">.</span><span class="token property-access">message</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> reason</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span></div></pre></div><h2 id="å€¼è¿‡æ»¤ä¸çŠ¶æ€å˜æ›´"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/async#å€¼è¿‡æ»¤ä¸çŠ¶æ€å˜æ›´"><span class="icon icon-link"></span></a>å€¼è¿‡æ»¤ä¸çŠ¶æ€å˜æ›´</h2><p>ä¸æ­¤åŒæ—¶ï¼Œå¦‚æœåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼ŒPromise çŠ¶æ€å€¼å·²å‘ç”Ÿå˜åŒ–ï¼Œåˆ™éœ€è¦æ ¹æ®ä¸åŒçŠ¶æ€ç›´æ¥è¿›è¡Œç›¸åº”ï¼Œä¾‹å¦‚ï¼Œå¦‚æœæ˜¯ <code>pending</code>ï¼Œåˆ™å°†ä»»åŠ¡æ”¾å…¥å¯¹åº”é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœä¸º <code>fulfilled</code>ï¼Œç›´æ¥è°ƒç”¨ resolveï¼Œå¦‚æœä¸º <code>rejected</code> åˆ™ç›´æ¥è°ƒç”¨ rejectã€‚å¯ä»¥ä½¿ç”¨ switch è¯­å¥è¿›è¡Œç­–ç•¥å¤„ç†ï¼Œå¦‚ä¸‹ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">resolves</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">resolvedFn</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">rejects</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">rejectedFn</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">resolvedFn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">rejectedFn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>æ­¤å¤„ <code>this.value</code> æ˜¯ä¸Šæ¬¡æ‰§è¡Œå®Œåå¾—åˆ°çš„å€¼ï¼Œèµ·åˆ°æš‚å­˜çš„ç›®çš„ã€‚è¡¥å……ä»¥ä¸Šä»£ç åï¼Œå®Œæ•´ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">type</span><span class="token plain"> </span><span class="token class-name maybe-class-name">FuncType</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token spread operator">...</span><span class="token plain">args</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">type</span><span class="token plain"> </span><span class="token class-name maybe-class-name">ExecutorFunc</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">resolveFunc</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">,</span><span class="token plain"> rejectFunc</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">enum</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token constant">PENDING</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;pending&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token constant">FULFILLED</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;fulfilled&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token constant">REJECTED</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;rejected&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">export</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">private</span><span class="token plain"> status </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">private</span><span class="token plain"> value </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">private</span><span class="token plain"> resolves</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">private</span><span class="token plain"> rejects</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token plain">executor</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">ExecutorFunc</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> resolve</span><span class="token punctuation">,</span><span class="token plain"> reject </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token plain">resolve</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">private</span><span class="token plain"> </span><span class="token function-variable function">resolve</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">resolvedVal</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> resolves</span><span class="token punctuation">,</span><span class="token plain"> status </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">status </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> resolvedVal</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">resolves</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> cb </span><span class="token operator">=</span><span class="token plain"> resolves</span><span class="token punctuation">.</span><span class="token method function property-access">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">cb</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token plain">resolvedVal</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">private</span><span class="token plain"> </span><span class="token function-variable function">reject</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">rejectedVal</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> rejects</span><span class="token punctuation">,</span><span class="token plain"> status </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">status </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> rejectedVal</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">rejects</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> cb </span><span class="token operator">=</span><span class="token plain"> rejects</span><span class="token punctuation">.</span><span class="token method function property-access">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">cb</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token plain">rejectedVal</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token function">then</span><span class="token punctuation">(</span><span class="token plain">resolveFunc</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">,</span><span class="token plain"> rejectFunc</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">HePromise</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">typeof</span><span class="token plain"> resolveFunc </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token string">&#x27;function&#x27;</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function-variable function">resolveFunc</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> value </span><span class="token arrow operator">=&gt;</span><span class="token plain"> value</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">typeof</span><span class="token plain"> rejectFunc </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token string">&#x27;function&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token operator">?</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function-variable function">rejectFunc</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> reason </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">throw</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name known-class-name class-name">Error</span><span class="token punctuation">(</span><span class="token plain">reason </span><span class="token keyword">instanceof</span><span class="token plain"> </span><span class="token class-name known-class-name class-name">Error</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> reason</span><span class="token punctuation">.</span><span class="token property-access">message</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> reason</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">resolve</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">resolvedFn</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">const</span><span class="token plain"> resolvedVal </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">resolveFunc</span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          resolvedVal </span><span class="token keyword">instanceof</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token operator">?</span><span class="token plain"> resolvedVal</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">resolve</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token operator">:</span><span class="token plain"> </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">resolvedVal</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">resolves</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">resolvedFn</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">rejectedFn</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">rejectFunc</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">const</span><span class="token plain"> rejectedVal </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">rejectFunc</span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            rejectedVal </span><span class="token keyword">instanceof</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token operator">?</span><span class="token plain"> rejectedVal</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">resolve</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token operator">:</span><span class="token plain"> </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">rejectedVal</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">resolves</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">resolvedFn</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">rejects</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">rejectedFn</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token function">resolvedFn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token function">rejectedFn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h2 id="åŒæ­¥ä»»åŠ¡å¤„ç†"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/async#åŒæ­¥ä»»åŠ¡å¤„ç†"><span class="icon icon-link"></span></a>åŒæ­¥ä»»åŠ¡å¤„ç†</h2><p>ä»¥ä¸Šæƒ…å†µæˆ‘ä»¬é—æ¼äº†ä¸€ä¸ªç‚¹ï¼Œå°±æ˜¯åŒæ­¥ä»»åŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»¥ä¸Šç¤ºä¾‹ä¸­ï¼Œåˆå§‹åŒ– HePromise ä¸­çš„ resolve éƒ½æ˜¯åœ¨æœªæ¥è¿›è¡Œçš„ï¼Œå¦‚æœåŒæ­¥æ‰§è¡Œ resolveï¼Œåˆ™ä»¥ä¸Šä»£ç ä¼šå‡ºç°é—®é¢˜ã€‚æˆ‘ä»¬çš„æ–¹æ¡ˆæ˜¯ï¼Œå°†åˆå§‹å¤„ç†é»˜è®¤æ”¾å…¥å®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨ <code>setTimeout</code> åŒ…è£¹ resolveï¼Œè¿™æ ·ä¸€æ¥ï¼Œå°±èƒ½ä¿è¯å³ä½¿æ˜¯åŒæ­¥ä»»åŠ¡ï¼Œä¹Ÿå¯ä»¥ä¿è¯åœ¨åŒæ­¥æ”¶é›†å®Œä»»åŠ¡ä»¥ååœ¨æ‰§è¡Œ executor ä¸­çš„ resolve å’Œ rejectã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">export</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">private</span><span class="token plain"> </span><span class="token function-variable function">resolve</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">resolvedVal</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> resolves</span><span class="token punctuation">,</span><span class="token plain"> status </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">status </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> resolvedVal</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">resolves</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> cb </span><span class="token operator">=</span><span class="token plain"> resolves</span><span class="token punctuation">.</span><span class="token method function property-access">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">cb</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token plain">resolvedVal</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>åŒç†å¯å®ç° reject é€»è¾‘ã€‚ç¼–å†™æµ‹è¯•ä»£ç ï¼Œå¦‚ä¸‹ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#x27;sync task&#x27;</span><span class="token punctuation">,</span><span class="token plain"> done </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> p </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token punctuation">(</span><span class="token plain">resolve </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  p</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">res </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token plain">res</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><h2 id="å…¶ä»–æ–¹æ³•å®ç°"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/async#å…¶ä»–æ–¹æ³•å®ç°"><span class="icon icon-link"></span></a>å…¶ä»–æ–¹æ³•å®ç°</h2><p>Promise ä¸­è¿˜åŒ…æ‹¬ catchã€finallyã€Promise.resolveã€Promise.rejectã€Promise.allã€Promise.raceï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åˆ†åˆ«æ¥å®ç°ã€‚</p><h3 id="catch"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/async#catch"><span class="icon icon-link"></span></a>catch</h3><p>å…¶å®æˆ‘ä»¬å¯ä»¥ç†è§£æ˜¯ then æ–¹æ³•çš„ä¸€ä¸ªå˜ä½“ï¼Œå°±æ˜¯ then æ–¹æ³•çœç•¥äº† resolve å‚æ•°ï¼Œå®ç°å¦‚ä¸‹ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token plain">rejectFnnc</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span><span class="token plain"> rejectFnnc</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h3 id="finally"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/async#finally"><span class="icon icon-link"></span></a>finally</h3><p>è¯¥æ–¹æ³•ä¿è¯ Promise ä¸ç®¡æ˜¯ fulfilled è¿˜æ˜¯ reject éƒ½ä¼šæ‰§è¡Œï¼Œéƒ½ä¼šæ‰§è¡ŒæŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚åœ¨ finally ä¹‹åï¼Œè¿˜å¯ä»¥ç»§ç»­ thenã€‚å¹¶ä¸”ä¼šå°†å€¼åŸå°ä¸åŠ¨çš„ä¼ é€’ç»™åé¢çš„ then å‡½æ•°ã€‚é’ˆå¯¹è¿™ä¸ªæœºåˆ¶ä¹Ÿæœ‰å¾ˆå¤šç†è§£ï¼Œç³™ç‰ˆçš„å¤„ç†å¦‚ä¸‹ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">finally</span><span class="token punctuation">(</span><span class="token plain">cb</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    value  </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> value</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    reason  </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">throw</span><span class="token plain"> reason</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>ä¸è¿‡ï¼Œå¦‚æœ Promise åœ¨ finally å‰è¿”å›äº†ä¸€ä¸ª reject çŠ¶æ€çš„ promiseï¼Œæƒ³ä¸Šé¢è¿™æ ·ç¼–å†™æ˜¯æ— æ³•æ»¡è¶³è¦æ±‚çš„ã€‚</p><blockquote><p>finally å¯¹è‡ªèº«è¿”å›çš„ promise çš„å†³è®®å½±å“æœ‰é™ï¼Œå®ƒå¯ä»¥å°†ä¸Šä¸€ä¸ª resolve æ”¹ä¸º rejectï¼Œä¹Ÿå¯ä»¥å°†ä¸Šä¸€ä¸ª reject æ”¹ä¸ºå¦ä¸€ä¸ª rejectï¼Œä½†ä¸èƒ½æŠŠä¸Šä¸€ä¸ª reject æ”¹ä¸º resolveã€‚</p></blockquote><p>è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å¯ä»¥å°† callback ä½¿ç”¨ Promise.resolve åŒ…è£¹ä¸€ä¸‹ï¼Œä¿è¯åç»­çš„ resolve çŠ¶æ€ã€‚å¦‚ä¸‹ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">finally</span><span class="token punctuation">(</span><span class="token plain">cb</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    value </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token maybe-class-name">HePromise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> value</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    reason </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token maybe-class-name">HePromise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token keyword">throw</span><span class="token plain"> reason </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h3 id="resolve"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/async#resolve"><span class="icon icon-link"></span></a>resolve</h3><p>è°ƒç”¨è¯¥é™æ€æ–¹æ³•å…¶å®å°±æ˜¯å°†å€¼ promise åŒ–ï¼Œå¦‚æœä¼ å…¥å€¼æœ¬èº«å°±æ˜¯ promise ç¤ºä¾‹ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™åˆ›å»ºæ–°çš„ promise ç¤ºä¾‹å¹¶è¿”å›ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">static</span><span class="token plain"> </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token plain">val </span><span class="token keyword">instanceof</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token plain"> val</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token punctuation">(</span><span class="token plain">resolve </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>ç¼–å†™æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#x27;HePromise.resolve&#x27;</span><span class="token punctuation">,</span><span class="token plain"> done </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">HePromise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">res </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token plain">res</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><h3 id="reject"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/async#reject"><span class="icon icon-link"></span></a>reject</h3><p>è¯¥æ–¹æ³•çš„åŸç†åŒ <code>resolve</code>ï¼Œç›´æ¥è´´å‡ºä»£ç </p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">static</span><span class="token plain"> </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">resolve</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>ç¼–å†™æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#x27;HePromise.reject &amp; catch&#x27;</span><span class="token punctuation">,</span><span class="token plain"> done </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">HePromise</span><span class="token punctuation">.</span><span class="token method function property-access">reject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    res </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token plain">res</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    error </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>æˆ–è€…é€šè¿‡ catch çš„æ–¹å¼ï¼Œå¦‚ä¸‹ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#x27;HePromise.reject &amp; catch&#x27;</span><span class="token punctuation">,</span><span class="token plain"> done </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">HePromise</span><span class="token punctuation">.</span><span class="token method function property-access">reject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">res </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token plain">res</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token plain">error </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">.</span><span class="token property-access">message</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toEqual</span><span class="token punctuation">(</span><span class="token string">&#x27;1&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>æ‰§è¡Œæµ‹è¯•ï¼Œæµ‹è¯•é€šè¿‡ã€‚</p><h3 id="all"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/async#all"><span class="icon icon-link"></span></a>all</h3><p>å°±æ˜¯å°†ä¼ å…¥æ•°ç»„ä¸­çš„å€¼ promise åŒ–ï¼Œç„¶åä¿è¯æ¯ä¸ªä»»åŠ¡éƒ½å¤„ç†åï¼Œæœ€ç»ˆ resolveã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">static</span><span class="token plain"> </span><span class="token function">all</span><span class="token punctuation">(</span><span class="token plain">promises</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> index </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> result</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> pLen </span><span class="token operator">=</span><span class="token plain"> promises</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">resolve</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      promises</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token plain">p </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token maybe-class-name">HePromise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token plain">p</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          val </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            index</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            result</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">index </span><span class="token operator">===</span><span class="token plain"> pLen</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">result</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          err </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>ç¼–å†™æµ‹è¯•ç”¨ä¾‹å¦‚ä¸‹ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#x27;HePromise.all&#x27;</span><span class="token punctuation">,</span><span class="token plain"> done </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">HePromise</span><span class="token punctuation">.</span><span class="token method function property-access">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">res </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token plain">res</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>æ‰§è¡Œæµ‹è¯•ï¼Œæµ‹è¯•é€šè¿‡ã€‚</p><h3 id="race"><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/async#race"><span class="icon icon-link"></span></a>race</h3><p>å°±æ˜¯å°†ä¼ å…¥æ•°ç»„ä¸­çš„å€¼ promise åŒ–ï¼Œåªè¦å…¶ä¸­ä¸€ä¸ªä»»åŠ¡å®Œæˆï¼Œå³å¯ resolveã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">static</span><span class="token plain"> </span><span class="token function">race</span><span class="token punctuation">(</span><span class="token plain">promises</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">HePromise</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">resolve</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      promises</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token plain">p </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token maybe-class-name">HePromise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token plain">p</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          val </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          err </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>ç¼–å†™æµ‹è¯•ç”¨ä¾‹ï¼š</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#x27;HePromise.race&#x27;</span><span class="token punctuation">,</span><span class="token plain"> done </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">HePromise</span><span class="token punctuation">.</span><span class="token method function property-access">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">22</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">33</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">res </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token plain">res</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>æ‰§è¡Œæµ‹è¯•ï¼Œæµ‹è¯•é€šè¿‡ã€‚</p><p>æ•´ä½“æµ‹è¯•ä»£ç æƒ…å†µå¦‚ä¸‹ï¼š</p><p><img src="/enhanfe/static/1.960f8c08.png" alt=""/></p><h2 id="å®Œæ•´ä»£ç "><a aria-hidden="true" tabindex="-1" href="/enhanfe//advanced/async#å®Œæ•´ä»£ç "><span class="icon icon-link"></span></a>å®Œæ•´ä»£ç </h2><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">type</span><span class="token plain"> </span><span class="token class-name maybe-class-name">FuncType</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token spread operator">...</span><span class="token plain">args</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">type</span><span class="token plain"> </span><span class="token class-name maybe-class-name">ExecutorFunc</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">resolveFunc</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">,</span><span class="token plain"> rejectFunc</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">enum</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token constant">PENDING</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;pending&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token constant">FULFILLED</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;fulfilled&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token constant">REJECTED</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;rejected&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">export</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">private</span><span class="token plain"> status </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">private</span><span class="token plain"> value </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">private</span><span class="token plain"> resolves</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">private</span><span class="token plain"> rejects</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">static</span><span class="token plain"> </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">HePromise</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">val </span><span class="token keyword">instanceof</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token plain"> val</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token punctuation">(</span><span class="token plain">resolve </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">static</span><span class="token plain"> </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">HePromise</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">resolve</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> reject </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">static</span><span class="token plain"> </span><span class="token function">all</span><span class="token punctuation">(</span><span class="token plain">promises</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">HePromise</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> index </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> result</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> pLen </span><span class="token operator">=</span><span class="token plain"> promises</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">resolve</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      promises</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token plain">p </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token maybe-class-name">HePromise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token plain">p</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          val </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            index</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            result</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">index </span><span class="token operator">===</span><span class="token plain"> pLen</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">result</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          err </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">static</span><span class="token plain"> </span><span class="token function">race</span><span class="token punctuation">(</span><span class="token plain">promises</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">HePromise</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">resolve</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      promises</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token plain">p </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token maybe-class-name">HePromise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token plain">p</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          val </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          err </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token plain">executor</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">ExecutorFunc</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> resolve</span><span class="token punctuation">,</span><span class="token plain"> reject </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token plain">resolve</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">private</span><span class="token plain"> </span><span class="token function-variable function">resolve</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">resolvedVal</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> resolves</span><span class="token punctuation">,</span><span class="token plain"> status </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">status </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> resolvedVal</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">resolves</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> cb </span><span class="token operator">=</span><span class="token plain"> resolves</span><span class="token punctuation">.</span><span class="token method function property-access">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">cb</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token plain">resolvedVal</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">private</span><span class="token plain"> </span><span class="token function-variable function">reject</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">rejectedVal</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> rejects</span><span class="token punctuation">,</span><span class="token plain"> status </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">status </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> rejectedVal</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">rejects</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> cb </span><span class="token operator">=</span><span class="token plain"> rejects</span><span class="token punctuation">.</span><span class="token method function property-access">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">cb</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token plain">rejectedVal</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token function">then</span><span class="token punctuation">(</span><span class="token plain">resolveFunc</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">,</span><span class="token plain"> rejectFunc</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">HePromise</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">typeof</span><span class="token plain"> resolveFunc </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token string">&#x27;function&#x27;</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function-variable function">resolveFunc</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> value </span><span class="token arrow operator">=&gt;</span><span class="token plain"> value</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">typeof</span><span class="token plain"> rejectFunc </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token string">&#x27;function&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token operator">?</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">rejects</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token operator">?</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function-variable function">rejectFunc</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> reason </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">throw</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name known-class-name class-name">Error</span><span class="token punctuation">(</span><span class="token plain">reason </span><span class="token keyword">instanceof</span><span class="token plain"> </span><span class="token class-name known-class-name class-name">Error</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> reason</span><span class="token punctuation">.</span><span class="token property-access">message</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> reason</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">resolve</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">resolvedFn</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">const</span><span class="token plain"> resolvedVal </span><span class="token operator">=</span><span class="token plain"> resolveFunc </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token function">resolveFunc</span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          resolvedVal </span><span class="token keyword">instanceof</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token operator">?</span><span class="token plain"> resolvedVal</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">resolve</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token operator">:</span><span class="token plain"> </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">resolvedVal</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">resolves</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">resolvedFn</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">rejectedFn</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">rejectFunc</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">const</span><span class="token plain"> rejectedVal </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">rejectFunc</span><span class="token punctuation">(</span><span class="token plain">val</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            rejectedVal </span><span class="token keyword">instanceof</span><span class="token plain"> </span><span class="token class-name maybe-class-name">HePromise</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token operator">?</span><span class="token plain"> rejectedVal</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">resolve</span><span class="token punctuation">,</span><span class="token plain"> reject</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token operator">:</span><span class="token plain"> </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">rejectedVal</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">resolves</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">resolvedFn</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">rejects</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">rejectedFn</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token function">resolvedFn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token function">rejectedFn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token plain">rejectFnnc</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FuncType</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span><span class="token plain"> rejectFnnc</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">finally</span><span class="token punctuation">(</span><span class="token plain">cb</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      value </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token maybe-class-name">HePromise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> value</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      reason </span><span class="token arrow operator">=&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token maybe-class-name">HePromise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">throw</span><span class="token plain"> reason</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div></div><div class="__dumi-default-layout-footer-meta"><span data-updated-text="æœ€åæ›´æ–°æ—¶é—´ï¼š">7/3/2021 16:25:18</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/enhanfe/umi.js"></script>
  </body>
</html>
